pipeline {
    agent any

    environment {
        HELM_HOME = '/usr/local/bin/helm'
        APP_NAME = 'myapp'
        IMAGE_TAG = 'latest'
    }

    triggers {
        // Automatically build when a GitHub webhook is triggered
        githubPush()
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Pulling latest code from GitHub...'
                git branch: 'main', url: 'https://github.com/Nonsocha/Helms-jenkins.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                sh 'docker build -t ${APP_NAME}:${IMAGE_TAG} .'
            }
        }

        stage('Run Container (Test Locally)') {
            steps {
                echo 'Running container locally for validation...'
                // Stop any existing container with same name
                sh 'docker rm -f ${APP_NAME} || true'
                sh 'docker run -d --name ${APP_NAME} -p 8081:80 ${APP_NAME}:${IMAGE_TAG}'
            }
        }

        stage('Validation Tests') {
            steps {
                echo 'Performing container validation tests...'
                // Simple health check to verify app is running
                sh '''
                sleep 5
                if curl -s http://localhost:8081 | grep -q "Welcome"; then
                    echo "App is running correctly!"
                else
                    echo "App failed validation!" && exit 1
                fi
                '''
            }
        }

        stage('Deploy with Helm (Local Minikube)') {
            steps {
                echo 'Deploying app to local Minikube using Helm...'
                sh "${HELM_HOME} upgrade --install ${APP_NAME} ./chart --values ./chart/values.yaml"
            }
        }
    }

    post {
        success {
            echo ' Build and deployment completed successfully!'
        }
        failure {
            echo ' Build failed. Check logs for details.'
        }
    }
}
